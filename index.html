<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Islandora usage stats by ryersonlibrary</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Islandora usage stats</h1>
        <p>Track views of islandora items, show most popular items, and recent activity</p>

        <p class="view"><a href="https://github.com/ryersonlibrary/islandora_usage_stats">View the Project on GitHub <small>ryersonlibrary/islandora_usage_stats</small></a></p>


        <ul>
          <li><a href="https://github.com/ryersonlibrary/islandora_usage_stats/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/ryersonlibrary/islandora_usage_stats/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/ryersonlibrary/islandora_usage_stats">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="islandora-usage-stats" class="anchor" href="#islandora-usage-stats"><span class="octicon octicon-link"></span></a>Islandora Usage Stats</h1>

<p>A simple module for Drupal 7 to track views of islandora items in the Ryerson Digital Repository.</p>

<p>Work based on code from <a href="https://github.com/roblib/islandora_scholar_upei">https://github.com/roblib/islandora_scholar_upei</a> and the scholar_tracking module for Drupal 6.</p>

<h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>View count uses session variables and defaults to a 5 minute cooldown for repeated requests</li>
<li>Tracks views of all types of objects in the repository</li>
<li>Access log for all views and downloads, can be disabled</li>
<li>IP Exclusion list to prevent artifically inflating counts while testing/developing</li>
<li>Drupal hook to allow other modules to fire events based on datastream download (hook_islandora_datastream_download)</li>
<li>Custom block to display most viewed items</li>
<li>Permissions to view usage data on an item page</li>
<li>Permissions to view most popular items block</li>
</ul><h2>
<a name="variables-available" class="anchor" href="#variables-available"><span class="octicon octicon-link"></span></a>Variables available:</h2>

<ul>
<li>
<strong>times_viewed:</strong> How many times the item has been viewed</li>
<li>
<strong>time_last_viewed:</strong> The datetime of the last recorded view in seconds since the unix epoch, format with a call to date()</li>
<li>
<strong>times_downloaded:</strong> How many times the item has been downloaded</li>
<li>
<strong>time_last_downloaded:</strong>  The datetime of the last download in seconds since the unix epoch, format with a call to date()</li>
<li>
<em>islandora_download_link:</em> Altered for the Islandora PDF module only. Redirects the download request to allow tracking of PDF downloads</li>
</ul><h2>
<a name="how-to-use" class="anchor" href="#how-to-use"><span class="octicon octicon-link"></span></a>How to use:</h2>

<ul>
<li>Place the downloaded module in your sites/all/modules folder and enable it</li>
<li>Configure any excluded IP addresses under Admin &gt; Config &gt; Islandora Usage Stats</li>
<li>Make sure user permissions are set appropriately under People &gt; Permissions</li>
<li>Edit your site theme file to output the stats where you want them</li>
<li>
<em>Optional</em>: use the hook_islandora_datastream_download to add functionality based on a datastream download</li>
</ul><h2>
<a name="how-to-display-tracking-data-on-your-template-files" class="anchor" href="#how-to-display-tracking-data-on-your-template-files"><span class="octicon octicon-link"></span></a>How to display tracking data on your template files:</h2>

<ul>
<li>In order to display tracking data for Islandora objects we need to modify your site's theme files</li>
<li>Add a function with the naming convention <code>islandora_usage_stats_preprocess_yourTemplateFileName</code> at the end of the islandora_usage_stats.module file (and replace <code>yourTemplateFileName</code> with the name of a template you want to override).

<ul>
<li>The function <code>islandora_usage_stats_preprocess_islandora_pdf</code> included in the <code>islandora_usage_stats.module</code> file can be used as an example and should be duplicated and renamed to affect other templates</li>
</ul>
</li>
<li>Copy the template file you want to override to your theme's <code>templates</code> directory and follow the example below to display tracking information</li>
</ul><h2>
<a name="an-example" class="anchor" href="#an-example"><span class="octicon octicon-link"></span></a>An example:</h2>

<p>We will add view and download stats to items in our Islandora PDF collection</p>

<h3>
<a name="step-1" class="anchor" href="#step-1"><span class="octicon octicon-link"></span></a>Step 1</h3>

<p>Navigate to your Drupal site's modules directory and clone the latest version of the module</p>

<p><code>$ cd &lt;your_Drupal_Site&gt;/sites/all/modules</code></p>

<p><code>$ git clone https://github.com/ryersonlibrary/islandora_usage_stats</code></p>

<h3>
<a name="step-2" class="anchor" href="#step-2"><span class="octicon octicon-link"></span></a>Step 2</h3>

<p>Open the <code>islandora_usage_stats.module</code> file in a text editor and create/edit the template preprocess function necessary to modify the Islandora PDF collection</p>

<p><code>$ vim islandora_usage_stats/islandora_usage_stats.module</code></p>

<p>The template preprocess function follows the naming convention of <code>islandora_usage_stats_preprocess_MODULE_NAME(&amp;$variables)</code> so make sure to edit yours accordingly</p>

<div class="highlight highlight-php"><pre><span class="k">function</span> <span class="nf">islandora_usage_stats_preprocess_islandora_pdf</span><span class="p">(</span><span class="err">$</span><span class="o">&amp;</span><span class="nx">variables</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$islandora_object</span> <span class="o">=</span> <span class="nv">$variables</span><span class="p">[</span><span class="s1">'islandora_object'</span><span class="p">];</span>
  <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$islandora_object</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
  <span class="nv">$label</span> <span class="o">=</span> <span class="nv">$islandora_object</span><span class="o">-&gt;</span><span class="na">label</span><span class="p">;</span>

  <span class="nv">$track</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IslandoraUsageStats</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'time_last_viewed'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$track</span><span class="o">-&gt;</span><span class="na">getLastViewedTime</span><span class="p">();</span>

  <span class="nv">$currentStats</span> <span class="o">=</span> <span class="nv">$track</span><span class="o">-&gt;</span><span class="na">getViewCount</span><span class="p">();</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'times_viewed'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$currentStats</span><span class="p">[</span><span class="s1">'views'</span><span class="p">];</span>

  <span class="nv">$downloaded</span> <span class="o">=</span> <span class="nv">$track</span><span class="o">-&gt;</span><span class="na">getDownloads</span><span class="p">(</span><span class="s1">'OBJ'</span><span class="p">);</span>

  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'times_downloaded'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$downloaded</span><span class="p">[</span><span class="s1">'downloads'</span><span class="p">];</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'time_last_downloaded'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$downloaded</span><span class="p">[</span><span class="s1">'time'</span><span class="p">];</span>

  <span class="c1">// we have added some bootstrap specific css classes and glyphicons to our link, include if desired</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'islandora_download_link'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span><span class="s1">'&lt;i class="glyphicon glyphicon-download"&gt; '</span> <span class="o">.</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Download PDF'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/i&gt;'</span><span class="p">,</span> <span class="s1">'download_ds/'</span> <span class="o">.</span> <span class="nv">$id</span> <span class="o">.</span> <span class="s1">'/OBJ/'</span> <span class="o">.</span> <span class="nv">$label</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'attributes'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
          <span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="s1">'btn btn-primary'</span>
      <span class="p">),</span>
      <span class="s1">'html'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
  <span class="p">));</span>
<span class="p">}</span>

</pre></div>

<h3>
<a name="step-3" class="anchor" href="#step-3"><span class="octicon octicon-link"></span></a>Step 3</h3>

<p>Navigate to your site's themes directory and copy the Islandora PDF template file so we can make changes to it and override it</p>

<p><code>$ cd &lt;your_Drupal_Site&gt;/sites/themes/&lt;yourtheme&gt;</code></p>

<p><code>$ cp &lt;your_Drupal_Site&gt;/sites/all/islandora_solution_pack_pdf/theme/islandora-pdf.tpl.php .</code></p>

<h3>
<a name="step-4" class="anchor" href="#step-4"><span class="octicon octicon-link"></span></a>Step 4</h3>

<p>Edit the copied template file to output our new tracking variables </p>

<h4>
<a name="before" class="anchor" href="#before"><span class="octicon octicon-link"></span></a>Before</h4>

<p><strong>/var/www/your_Drupal_Site/sites/themes/your_Theme/islandora-pdf.tpl.php</strong></p>

<div class="highlight highlight-html"><pre><span class="c">&lt;!------- SNIP ----------&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-pdf-content-wrapper clearfix"</span><span class="nt">&gt;</span>
<span class="cp">&lt;?php if (isset($islandora_content)): ?&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-pdf-content"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php print $islandora_content; ?&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;?php if (isset($islandora_download_link)): ?&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-download-link"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php print $islandora_download_link; ?&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;?php endif; ?&gt;</span>

<span class="cp">&lt;?php endif; ?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>

<h4>
<a name="after" class="anchor" href="#after"><span class="octicon octicon-link"></span></a>After</h4>

<p><strong>/var/www/your_Drupal_Site/sites/themes/your_Theme/islandora-pdf.tpl.php</strong></p>

<div class="highlight highlight-html"><pre><span class="c">&lt;!------- SNIP ----------&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-pdf-content-wrapper clearfix"</span><span class="nt">&gt;</span>
<span class="cp">&lt;?php if (isset($islandora_content)): ?&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-pdf-content"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php print $islandora_content; ?&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;?php if (isset($islandora_download_link)): ?&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-download-link"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php print $islandora_download_link; ?&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;?php endif; ?&gt;</span>

<span class="cp">&lt;?php endif; ?&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="c">&lt;!-- usage stats --&gt;</span>
<span class="cp">&lt;?php if (module_exists('islandora_usage_stats')): ?&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"islandora-usage-stats"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- we have added some bootstrap specific css classes (badge) to our view counts, include if desired --&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    Viewed: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"badge"</span><span class="nt">&gt;</span><span class="cp">&lt;?php print $times_viewed ?&gt;</span><span class="nt">&lt;/span&gt;</span> Last viewed: <span class="cp">&lt;?php print $time_last_viewed==NULL ? 'Never' : date('g:ia, M d, Y', $time_last_viewed); ?&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    Downloaded: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"badge"</span><span class="nt">&gt;</span><span class="cp">&lt;?php print $times_downloaded ?&gt;</span><span class="nt">&lt;/span&gt;</span> Last downloaded: <span class="cp">&lt;?php print $time_last_downloaded==NULL ? 'Never' : date('g:ia, M d, Y', $time_last_downloaded); ?&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;?php endif; ?&gt;</span>
<span class="c">&lt;!-- end usage stats --&gt;</span>
</pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/ryersonlibrary">ryersonlibrary</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>